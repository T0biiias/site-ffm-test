From dd0c221426952d1c0e7c1399d4c599442d2995ba Mon Sep 17 00:00:00 2001
From: Grische <github@grische.xyz>
Date: Mon, 28 Oct 2024 13:12:39 +0100
Subject: [PATCH 09/11] Fix issue with introduction of batman TQ propery in
 respondd
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Gluon introduced adding the TQ property of batman to the gateway
information. As we do use BATMAN V, where a TQ property no longer
exists, gateway information was dropped completely from respondd content
and our status page.

This change fixes this, by using the THROUGHPUT propery instead.

Co-Authored-By: Steffen FÃ¶rster <nemesis@chemnitz.freifunk.net>
Co-Authored-By: Malte Wedel <ich@malte.de>
---
 package/gluon-mesh-batman-adv/src/respondd-statistics.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/package/gluon-mesh-batman-adv/src/respondd-statistics.c b/package/gluon-mesh-batman-adv/src/respondd-statistics.c
index 28131fda..2fee70de 100644
--- a/package/gluon-mesh-batman-adv/src/respondd-statistics.c
+++ b/package/gluon-mesh-batman-adv/src/respondd-statistics.c
@@ -41,7 +41,7 @@ struct gw_netlink_opts {
 static const enum batadv_nl_attrs gateways_mandatory[] = {
 	BATADV_ATTR_ORIG_ADDRESS,
 	BATADV_ATTR_ROUTER,
-	BATADV_ATTR_TQ,
+	BATADV_ATTR_THROUGHPUT,
 };
 
 static int parse_gw_list_netlink_cb(struct nl_msg *msg, void *arg)
@@ -52,7 +52,7 @@ static int parse_gw_list_netlink_cb(struct nl_msg *msg, void *arg)
 	struct genlmsghdr *ghdr;
 	uint8_t *orig;
 	uint8_t *router;
-	uint8_t tq;
+	uint32_t throughput;
 	struct gw_netlink_opts *opts;
 	char addr[18];
 
@@ -80,13 +80,13 @@ static int parse_gw_list_netlink_cb(struct nl_msg *msg, void *arg)
 
 	orig = nla_data(attrs[BATADV_ATTR_ORIG_ADDRESS]);
 	router = nla_data(attrs[BATADV_ATTR_ROUTER]);
-	tq = nla_get_u8(attrs[BATADV_ATTR_TQ]);
+	throughput = nla_get_u32(attrs[BATADV_ATTR_THROUGHPUT]);
 
 	sprintf(addr, "%02x:%02x:%02x:%02x:%02x:%02x",
 		orig[0], orig[1], orig[2], orig[3], orig[4], orig[5]);
 
 	json_object_object_add(opts->obj, "gateway", json_object_new_string(addr));
-	json_object_object_add(opts->obj, "gateway_tq", json_object_new_int(tq));
+	json_object_object_add(opts->obj, "gateway_throughput", json_object_new_int(throughput));
 
 	sprintf(addr, "%02x:%02x:%02x:%02x:%02x:%02x",
 		router[0], router[1], router[2], router[3], router[4], router[5]);
-- 
2.34.1

